<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Quiz Guarda Civil — App</title>
  <style>
    /* Reset + base */
    :root{
      --bg:#0f1724; /* dark navy */
      --card:#0b1220;
      --accent:#06b6d4;
      --muted:#94a3b8;
      --text:#e6eef8;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#071022 0%, #071826 100%); color:var(--text);}

    /* App shell */
    .app{max-width:980px;margin:20px auto;padding:16px;}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    .title{font-size:18px;font-weight:700}

    /* Card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:20px;margin-top:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}

    /* Question area - increased size */
    .question{font-size:20px;line-height:1.35;font-weight:600;margin-bottom:18px}
    .question.small{font-size:16px}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .choice{padding:12px;border-radius:10px;background:var(--glass);cursor:pointer;border:1px solid rgba(255,255,255,0.03);}
    .choice.selected{outline:2px solid rgba(6,182,212,0.18);box-shadow:0 4px 10px rgba(2,6,23,0.6)}

    /* Controls */
    .controls{display:flex;gap:8px;align-items:center;margin-top:14px}
    .btn{padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,#0b1220,#071026);border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#0ea5b8);color:#022; font-weight:700}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}

    /* Bottom bar (mobile safe) */
    .bottom-bar{position:fixed;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;padding:10px;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.85));backdrop-filter:blur(6px);gap:8px}
    .bottom-inner{max-width:980px;width:100%;padding:6px 12px;display:flex;justify-content:space-between;align-items:center}

    /* Small screen adjustments */
    @media (max-width:720px){
      .app{padding:10px;margin:8px}
      .title{font-size:16px}
      .question{font-size:18px}
      .choices{grid-template-columns:1fr;}
      .logo{width:40px;height:40px}
      .card{padding:14px;border-radius:12px}
      .bottom-bar{padding:8px}
      /* ensure bottom buttons don't overlap quiz next button: add bottom padding to content area */
      body{padding-bottom:86px}
    }

    /* Feedback / small text */
    .muted{color:var(--muted);font-size:13px}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:96px;background:#052033;padding:10px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}

    /* resend smaller */
    .resend{font-size:13px;padding:8px;border-radius:8px}

    /* accessibility focus */
    .choice:focus{outline:3px solid rgba(6,182,212,0.18)}

  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <div class="logo">G</div>
      <div>
        <!-- Title forced to show on small screens by being regular text, not hidden -->
        <div class="title" id="appTitle">Quiz Guarda Civil — Simulado</div>
        <div class="muted" id="subtitle">Pratique. Aprenda. Prove.</div>
      </div>
      <div style="margin-left:auto" class="muted" id="accessBadge">—</div>
    </header>

    <main>
      <section class="card" id="quizCard">
        <div class="meta">
          <div class="muted" id="progress">Pergunta <span id="qIndex">1</span> / <span id="qTotal">10</span></div>
          <div class="muted" id="timeLeft">—</div>
        </div>

        <div>
          <div class="question" id="questionText">Carregando pergunta...</div>
          <div class="choices" id="choicesContainer">
            <!-- choices injected here -->
          </div>
        </div>

        <div class="controls" style="margin-top:20px;">
          <button class="btn ghost" id="prevBtn">Anterior</button>
          <button class="btn primary" id="nextBtn">Próximo</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <!-- Resend (Enviar novamente) -->
            <button class="btn resend" id="resendBtn" title="Enviar novamente (resend)">Enviar novamente</button>
            <!-- Small debug / submit -->
            <button class="btn" id="submitBtn">Enviar</button>
          </div>
        </div>

        <div style="margin-top:12px" class="muted">Dica: toque na alternativa para selecionar. O modo demo é concedido automaticamente por 4 horas.</div>
      </section>
    </main>
  </div>

  <!-- fixed bottom controls to avoid overlap on small screens -->
  <div class="bottom-bar" aria-hidden="false">
    <div class="bottom-inner">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="homeBtn">Início</button>
        <button class="btn" id="reviewBtn">Revisar</button>
        <button class="btn" id="settingsBtn">Configurações</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="helpBtn">Ajuda</button>
      </div>
    </div>
  </div>

  <div id="toastRoot"></div>

  <script>
    /*
      Instruções importantes sobre o que implementei:
      - "Caixa de resgate" (rescue box) foi removida do UI.
      - Acesso demo automático: ao primeiro carregamento o cliente tenta iniciar demo via (/api/demo/start).
         Se o servidor confirmar, o token/expiry será guardado. Em qualquer caso o cliente também cria um demo local com 4h.
         IMPORTANT: para manter o limite real, o servidor deve validar o token/limit quando o usuário pede conteúdo real.
      - Botão "Enviar novamente" (resend) reenvia a última submissão ao endpoint de submissão (placeholder /api/submit).
      - Tamanho das perguntas aumentado e responsivo.
      - Ajustes para evitar que os botões cobrem o botão Próximo no smartphone (fix: bottom padding + fixed bottom bar).
    */

    const state = {
      qIndex: 0,
      questions: [],
      lastSubmission: null,
      demo: {active:false, expiresAt:null, token:null}
    };

    // sample data - in production your server returns real questions
    const SAMPLE = [
      {id:1,text:'Qual o objetivo principal da Guarda Civil?', choices:['Manutenção da ordem pública','Apenas fiscalização de trânsito','Atendimento exclusivamente administrativo','Nenhuma das alternativas']},
      {id:2,text:'A postura profissional exige:', choices:['Disciplina e cortesia','Agressividade','Isolamento do cidadão','Apenas conhecimento técnico']},
      {id:3,text:'Quando acionar o suporte jurídico?', choices:['Em ocorrências que exijam medidas legais','Sempre','Nunca','Somente em dias úteis']}
    ];

    // DOM refs
    const questionText = document.getElementById('questionText');
    const choicesContainer = document.getElementById('choicesContainer');
    const qIndexEl = document.getElementById('qIndex');
    const qTotalEl = document.getElementById('qTotal');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    const submitBtn = document.getElementById('submitBtn');
    const resendBtn = document.getElementById('resendBtn');
    const accessBadge = document.getElementById('accessBadge');
    const timeLeft = document.getElementById('timeLeft');

    // util: show toast
    function toast(msg, ms=2500){
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.getElementById('toastRoot').appendChild(t);
      setTimeout(()=>{t.remove()},ms);
    }

    // initialize app
    function init(){
      // load questions (simulate async)
      state.questions = SAMPLE.slice();
      qTotalEl.textContent = state.questions.length;
      state.qIndex = 0;

      // request/ensure demo access
      ensureDemoAccess();

      renderQuestion();
      attachHandlers();
      startDemoTimer();
    }

    function renderQuestion(){
      const q = state.questions[state.qIndex];
      if(!q){ questionText.textContent='Sem perguntas'; choicesContainer.innerHTML=''; return; }
      qIndexEl.textContent = state.qIndex+1;
      questionText.textContent = q.text;

      // render choices
      choicesContainer.innerHTML='';
      q.choices.forEach((c,i)=>{
        const b = document.createElement('button');
        b.className='choice';
        b.setAttribute('data-idx',i);
        b.setAttribute('aria-label', 'Alternativa '+(i+1));
        b.textContent = c;
        b.addEventListener('click', ()=>{
          // select single
          document.querySelectorAll('.choice').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
        });
        choicesContainer.appendChild(b);
      });
    }

    function attachHandlers(){
      nextBtn.addEventListener('click', ()=>{
        if(state.qIndex < state.questions.length-1){ state.qIndex++; renderQuestion(); }
        else{ toast('Fim do simulado.'); }
      });
      prevBtn.addEventListener('click', ()=>{ if(state.qIndex>0){ state.qIndex--; renderQuestion(); } });

      submitBtn.addEventListener('click', async ()=>{
        const sel = document.querySelector('.choice.selected');
        if(!sel){ toast('Selecione uma alternativa antes de enviar.'); return; }
        const payload = { questionId: state.questions[state.qIndex].id, choiceIndex: parseInt(sel.dataset.idx,10), ts: Date.now(), demo: state.demo.active };
        state.lastSubmission = payload;
        try{
          await submitToServer(payload);
          toast('Resposta enviada.');
        }catch(e){
          console.error(e); toast('Falha ao enviar: ' + (e.message||'erro de rede')); 
        }
      });

      resendBtn.addEventListener('click', async ()=>{
        if(!state.lastSubmission){ toast('Sem envio anterior para reenviar.'); return; }
        try{
          await submitToServer(state.lastSubmission, true);
          toast('Reenvio realizado.');
        }catch(e){ console.error(e); toast('Reenvio falhou.'); }
      });

      // accessibility: keyboard next/prev
      document.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowRight') nextBtn.click();
        if(e.key==='ArrowLeft') prevBtn.click();
      });
    }

    // Simulate server submit - use fetch to /api/submit (placeholder)
    async function submitToServer(payload, isResend=false){
      // If you have a real server, implement server-side validation and store results.
      const endpoint = '/api/submit';
      // attempt network call but fallback to local "ok"
      try{
        const res = await fetch(endpoint, {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({...payload,resend:isResend, demoToken: state.demo.token})});
        if(!res.ok) throw new Error('server '+res.status);
        return await res.json();
      }catch(e){
        // fallback: simulate success but mark as offline-submitted
        console.debug('submitToServer fallback', e);
        localStorage.setItem('offline-submission-'+Date.now(), JSON.stringify(payload));
        return {ok:true, offline:true};
      }
    }

    /* Demo access handling */
    function ensureDemoAccess(){
      const saved = JSON.parse(localStorage.getItem('demo_access')||'null');
      const now = Date.now();
      if(saved && saved.expiresAt > now){
        state.demo = saved; state.demo.active = true; updateAccessBadge(); return;
      }
      // Try to request demo from server (best-effort)
      fetch('/api/demo/start',{method:'POST'}).then(async res=>{
        if(res.ok){
          try{ const body = await res.json();
            // expect { token, expiresAt }
            if(body.token && body.expiresAt){
              state.demo = {active:true, token: body.token, expiresAt: body.expiresAt};
              localStorage.setItem('demo_access', JSON.stringify(state.demo));
              updateAccessBadge();
              return;
            }
          }catch(e){}
        }
        // if server didn't provide, fallback to local 4h demo
        beginLocalDemo();
      }).catch(()=>{
        beginLocalDemo();
      });
    }

    function beginLocalDemo(){
      const now = Date.now();
      const expiresAt = now + 4*60*60*1000; // 4 hours
      state.demo = {active:true, token: 'local-demo', expiresAt};
      localStorage.setItem('demo_access', JSON.stringify(state.demo));
      updateAccessBadge();
    }

    function updateAccessBadge(){
      if(state.demo && state.demo.active){
        const d = new Date(state.demo.expiresAt);
        accessBadge.textContent = 'Demo até ' + d.toLocaleString();
      }else accessBadge.textContent='Sem acesso';
    }

    // show countdown timer for demo
    let demoTimerInterval = null;
    function startDemoTimer(){
      if(demoTimerInterval) clearInterval(demoTimerInterval);
      demoTimerInterval = setInterval(()=>{
        const now=Date.now();
        if(state.demo && state.demo.expiresAt){
          const left = state.demo.expiresAt - now;
          if(left<=0){ state.demo.active=false; updateAccessBadge(); timeLeft.textContent = 'Expirado'; clearInterval(demoTimerInterval); return; }
          const h = Math.floor(left/3600000); const m = Math.floor((left%3600000)/60000); const s = Math.floor((left%60000)/1000);
          timeLeft.textContent = `${h}h ${m}m ${s}s`;
        } else timeLeft.textContent='—';
      }, 1000);
    }

    // start
    init();

  </script>
</body>
</html>
